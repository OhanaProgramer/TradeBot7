{% extends "base.html" %}

{% block content %}
  <div class="container">
    <h3>Portfolio Snapshot</h3>
    <div class="row mb-4" id="portfolioSnapshot">
      <div class="col-md-4">
        <div class="card text-bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title">Total Value</h5>
            <p class="card-text" id="totalValue">--</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">Top 3 Winners</h5>
            <ul class="list-unstyled mb-0" id="topWinners">
              <li>--</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-bg-danger mb-3">
          <div class="card-body">
            <h5 class="card-title">Top 3 Losers</h5>
            <ul class="list-unstyled mb-0" id="topLosers">
              <li>--</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-bg-info mb-3">
          <div class="card-body">
            <h5 class="card-title">Total P/L</h5>
            <p class="card-text" id="totalPL">--</p>
          </div>
        </div>
      </div>
    </div>

    <h3>Alerts Overview</h3>
    <div class="row mb-4" id="alertsOverview">
      <div class="col-md-3">
        <div class="card text-bg-danger mb-3">
          <div class="card-body">
            <h5 class="card-title">Critical</h5>
            <p class="card-text" id="alertCritical">--</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-warning mb-3">
          <div class="card-body">
            <h5 class="card-title">Caution</h5>
            <p class="card-text" id="alertCaution">--</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">Positive</h5>
            <p class="card-text" id="alertPositive">--</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-info mb-3">
          <div class="card-body">
            <h5 class="card-title">Info</h5>
            <p class="card-text" id="alertInfo">--</p>
          </div>
        </div>
      </div>
    </div>

    <h3>Positions Overview</h3>
    <table id="positionsTable" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Price</th>
          <th>Trend</th>
          <th>Alert</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="mt-2">
      <a href="/strategy" class="btn btn-link">View full strategy page</a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadPositions() {
  try {
    console.log("Fetching /api/positions...");
    const res = await fetch('/api/positions');
    if (!res.ok) {
      console.error("Failed to load /api/positions:", res.status);
      return;
    }
    const data = await res.json();
    console.log("Positions data:", data);

    const positions = data.positions || [];
    const tbody = document.querySelector('#positionsTable tbody');
    tbody.innerHTML = '';

    if (!Array.isArray(positions) || positions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">No data available</td></tr>';
      document.getElementById('totalValue').textContent = '--';
      document.getElementById('topWinners').innerHTML = '<li>--</li>';
      document.getElementById('topLosers').innerHTML = '<li>--</li>';
      document.getElementById('totalPL').textContent = '--';
      document.getElementById('alertCritical').textContent = '--';
      document.getElementById('alertCaution').textContent = '--';
      document.getElementById('alertPositive').textContent = '--';
      document.getElementById('alertInfo').textContent = '--';
      return;
    }

    // Use portfolio summary data from API
    const summary = data.portfolio_summary || {};
    document.getElementById('totalValue').textContent = summary.total_value ? '$' + summary.total_value.toFixed(2) : '--';
    document.getElementById('totalPL').textContent = summary.total_pl_percent !== undefined ? summary.total_pl_percent.toFixed(2) + '%' : '--';

    const winnersList = (summary.top_winners && summary.top_winners.length)
      ? summary.top_winners.map(w => `<li>${w.ticker}: ${w.pl_percent.toFixed(2)}%</li>`).join('')
      : '<li>--</li>';
    document.getElementById('topWinners').innerHTML = winnersList;

    const losersList = (summary.top_losers && summary.top_losers.length)
      ? summary.top_losers.map(l => `<li>${l.ticker}: ${l.pl_percent.toFixed(2)}%</li>`).join('')
      : '<li>--</li>';
    document.getElementById('topLosers').innerHTML = losersList;

    const counts = (summary.alert_counts) || {};
    document.getElementById('alertCritical').textContent = counts.critical ?? 0;
    document.getElementById('alertCaution').textContent = counts.caution ?? 0;
    document.getElementById('alertPositive').textContent = counts.positive ?? 0;
    document.getElementById('alertInfo').textContent = counts.info ?? 0;

    // Filter positions to only those with actionable alerts
    const alertPositions = positions.filter(item => {
      const alerts = item.alerts || {};
      return (alerts.attention && alerts.attention !== 'none') || alerts.stop_near === true;
    });

    if (alertPositions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">No critical alerts</td></tr>';
    } else {
      alertPositions.forEach(item => {
        const alerts = item.alerts || {};
        const alertBadge = alerts.attention && alerts.attention !== 'none'
          ? `<span class="badge bg-danger">${alerts.attention}</span>`
          : alerts.stop_near === true
            ? `<span class="badge bg-warning">Stop Near</span>`
            : `<span class="badge bg-success">OK</span>`;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="/strategy#${item.ticker}" style="text-decoration: underline; color: blue;"><strong>${item.ticker || '--'}</strong></a></td>
          <td>${item.price ?? '--'}</td>
          <td>${item.trend ?? '--'}</td>
          <td>${alertBadge}</td>`;
        tbody.appendChild(row);
      });
    }


  } catch (err) {
    console.error('Error loading positions:', err);
    const tbody = document.querySelector('#positionsTable tbody');
    tbody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
    document.getElementById('totalValue').textContent = '--';
    document.getElementById('topWinners').innerHTML = '<li>--</li>';
    document.getElementById('topLosers').innerHTML = '<li>--</li>';
    document.getElementById('totalPL').textContent = '--';
    document.getElementById('alertCritical').textContent = '--';
    document.getElementById('alertCaution').textContent = '--';
    document.getElementById('alertPositive').textContent = '--';
    document.getElementById('alertInfo').textContent = '--';
  }
}

loadPositions();
setInterval(loadPositions, 300000); // refresh every 5 min
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}